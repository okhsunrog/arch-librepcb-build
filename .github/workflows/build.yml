name: Build Arch Package

on:
  push:
    branches: [master, main]
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Free up disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build in Arch container
        run: |
          docker run --rm -v ${{ github.workspace }}:/workspace -w /workspace \
            archlinux:base-devel bash -c '
              set -e

              # Setup pacman
              pacman-key --init
              pacman -Syu --noconfirm

              # Add chaotic-aur for polyclipping and fontobene-qt-qt6
              pacman-key --recv-key 3056513887B78AEB --keyserver keyserver.ubuntu.com
              pacman-key --lsign-key 3056513887B78AEB
              pacman -U --noconfirm \
                "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-keyring.pkg.tar.zst" \
                "https://cdn-mirror.chaotic.cx/chaotic-aur/chaotic-mirrorlist.pkg.tar.zst"
              echo -e "\n[chaotic-aur]\nInclude = /etc/pacman.d/chaotic-mirrorlist" >> /etc/pacman.conf
              pacman -Sy --noconfirm

              # Install dependencies
              pacman -S --noconfirm --needed \
                cmake pkg-config qt6-base qt6-svg qt6-tools \
                glu hicolor-icon-theme muparser opencascade polyclipping \
                fontobene-qt-qt6 gtest rust unzip

              # Create build user
              useradd -m builder
              chown -R builder:builder /workspace
              echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

              # Build (skip PGP check since we verify sha256sum)
              su builder -c "makepkg -s --noconfirm --skippgpcheck"
            '

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: librepcb-package
          path: "*.pkg.tar.zst"
          retention-days: 30

      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*.pkg.tar.zst"
